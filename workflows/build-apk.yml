# Rotating Art Launcher (RAL) å…¨è‡ªåŠ¨APKæ„å»ºå·¥ä½œæµ
# ç‰¹æ€§ï¼šDebug/ReleaseåŒç‰ˆæœ¬ã€é”™è¯¯æ•è·ã€ç¯å¢ƒæ ¡éªŒã€ç¼“å­˜ä¼˜åŒ–ã€å¤šæ¶æ„æ”¯æŒã€æ—¥å¿—è¾“å‡º
name: RAL Full Auto Build APK

# è§¦å‘è§„åˆ™ï¼šä¸»åˆ†æ”¯æ¨é€/PR/æ‰‹åŠ¨è§¦å‘ï¼Œå¿½ç•¥éä»£ç æ–‡ä»¶
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'LICENSE'
      - 'icons/**'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒä¼ å‚é€‰æ‹©æ„å»ºç‰ˆæœ¬ï¼‰
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹ (debug/release/all)'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
          - all

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç»Ÿä¸€é…ç½®ï¼‰
env:
  ANDROID_COMPILE_SDK: "28"          # RALæœ€ä½å…¼å®¹Android 9.0
  ANDROID_BUILD_TOOLS: "34.0.0"      # ç¨³å®šç‰ˆæ„å»ºå·¥å…·
  ANDROID_NDK_VERSION: "25.2.9519653" # RALæ¸²æŸ“å™¨ä¾èµ–çš„NDKç‰ˆæœ¬
  ANDROID_CMAKE_VERSION: "3.22.1"    # é€‚é…RALçš„CMakeç‰ˆæœ¬
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true" # ä¼˜åŒ–Gradleæ„å»º

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 45 # æ„å»ºè¶…æ—¶ä¿æŠ¤ï¼ˆé¿å…æ— é™è¿è¡Œï¼‰
    permissions:
      contents: read
      actions: write

    steps:
      # 1. æ‹‰å–ä»£ç ï¼ˆå®Œæ•´å†å²ï¼Œé¿å…Gradleä¾èµ–è§£æé—®é¢˜ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive # æ‹‰å–å­æ¨¡å—ï¼ˆRALå¯èƒ½ä¾èµ–ç¬¬ä¸‰æ–¹å­æ¨¡å—ï¼‰

      # 2. ç¯å¢ƒæ ¡éªŒï¼šæ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Validate Project Structure
        run: |
          echo "ğŸ” æ ¡éªŒRALé¡¹ç›®æ ¸å¿ƒæ–‡ä»¶..."
          if [ ! -f "./gradlew" ]; then
            echo "âŒ æœªæ‰¾åˆ°gradlewæ–‡ä»¶ï¼Œæ„å»ºç»ˆæ­¢ï¼"
            exit 1
          fi
          if [ ! -d "./app" ]; then
            echo "âŒ æœªæ‰¾åˆ°appæ¨¡å—ç›®å½•ï¼Œæ„å»ºç»ˆæ­¢ï¼"
            exit 1
          fi
          echo "âœ… é¡¹ç›®ç»“æ„æ ¡éªŒé€šè¿‡"

      # 3. é…ç½®JDK 17ï¼ˆRALåŸºäºKotlin 2.0å¿…éœ€ï¼‰
      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle' # ç¼“å­˜Gradleä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      # 4. é…ç½®Android SDK/NDK/CMakeï¼ˆé€‚é…RALå¤šæ¸²æŸ“å™¨ï¼‰
      - name: Set Up Android Environment
        uses: android-actions/setup-android@v3
        with:
          api-levels: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
          ndk: ${{ env.ANDROID_NDK_VERSION }}
          cmake: ${{ env.ANDROID_CMAKE_VERSION }}
          packages: |
            platform-tools
            extras;android;m2repository
            extras;google;m2repository
          cache: true # ç¼“å­˜Android SDKï¼Œå‡å°‘é‡å¤ä¸‹è½½

      # 5. é…ç½®Local Propertiesï¼ˆæŒ‡å®šNDK/SDKè·¯å¾„ï¼Œé€‚é…RALæ„å»ºï¼‰
      - name: Configure Local Properties
        run: |
          echo "ğŸ“ ç”Ÿæˆlocal.propertiesæ–‡ä»¶..."
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          echo "ndk.dir=${ANDROID_SDK_ROOT}/ndk/${ANDROID_NDK_VERSION}" >> local.properties
          cat local.properties # æ‰“å°éªŒè¯
          echo "âœ… Local Propertiesé…ç½®å®Œæˆ"

      # 6. ç¼“å­˜ä¼˜åŒ–ï¼šGradleä¾èµ–+æ„å»ºè¾“å‡º
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle/caches
            .gradle/wrapper
            app/build/cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 7. æˆäºˆæ‰§è¡Œæƒé™+æ¸…ç†æ—§æ„å»º
      - name: Prepare Build Environment
        run: |
          echo "ğŸ”§ é…ç½®æ„å»ºç¯å¢ƒ..."
          chmod +x ./gradlew
          ./gradlew clean --quiet # æ¸…ç†æ—§æ„å»ºäº§ç‰©ï¼Œé¿å…å†²çª
          echo "âœ… æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

      # 8. æ„å»ºDebugç‰ˆAPKï¼ˆæ ¸å¿ƒï¼Œæ— éœ€ç­¾åï¼‰
      - name: Build Debug APK
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'all' || github.event_name != 'workflow_dispatch'
        id: build_debug
        continue-on-error: false # æ„å»ºå¤±è´¥ç›´æ¥ç»ˆæ­¢
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºDebugç‰ˆAPK..."
          ./gradlew assembleDebug --stacktrace --info
          # éªŒè¯APKæ˜¯å¦ç”Ÿæˆ
          DEBUG_APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          if [ -z "$DEBUG_APK_PATH" ]; then
            echo "âŒ Debug APKæ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… Debug APKæ„å»ºå®Œæˆï¼š$DEBUG_APK_PATH"
          echo "debug_apk_path=$DEBUG_APK_PATH" >> $GITHUB_OUTPUT

      # 9. æ„å»ºReleaseç‰ˆAPKï¼ˆå¯é€‰ï¼Œä»…æ‰‹åŠ¨è§¦å‘/allæ—¶æ‰§è¡Œï¼Œæ— ç­¾åä»…ç¼–è¯‘ï¼‰
      - name: Build Release APK (UnSigned)
        if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'all'
        id: build_release
        continue-on-error: true # Releaseæ— ç­¾åæ—¶å…è®¸å¤±è´¥ï¼Œä»…è¾“å‡ºæ—¥å¿—
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºReleaseç‰ˆAPKï¼ˆæ— ç­¾åï¼‰..."
          ./gradlew assembleRelease --stacktrace --info
          # éªŒè¯APKæ˜¯å¦ç”Ÿæˆ
          RELEASE_APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -z "$RELEASE_APK_PATH" ]; then
            echo "âš ï¸ Release APKæ„å»ºå¤±è´¥ï¼ˆæ— ç­¾åï¼‰ï¼Œè¯·é…ç½®ç­¾ååé‡è¯•"
            exit 0 # éå¼ºåˆ¶å¤±è´¥
          fi
          echo "âœ… Release APKï¼ˆæ— ç­¾åï¼‰æ„å»ºå®Œæˆï¼š$RELEASE_APK_PATH"
          echo "release_apk_path=$RELEASE_APK_PATH" >> $GITHUB_OUTPUT

      # 10. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆæŒ‰æ„å»ºç±»å‹åˆ†ç±»ï¼‰
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RAL-APKs-${{ github.sha }}-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
          retention-days: 90 # äº§ç‰©ä¿ç•™90å¤©
          if-no-files-found: warn # æ— æ–‡ä»¶ä»…è­¦å‘Šï¼Œä¸ç»ˆæ­¢å·¥ä½œæµ

      # 11. è¾“å‡ºæ„å»ºæ€»ç»“
      - name: Build Summary
        run: |
          echo "ğŸ“Š æ„å»ºæ€»ç»“ï¼š"
          echo "- è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}"
          echo "- æ„å»ºç±»å‹ï¼š${{ github.event.inputs.build_type || 'debug' }}"
          echo "- Debug APKè·¯å¾„ï¼š${{ steps.build_debug.outputs.debug_apk_path || 'æœªæ„å»º' }}"
          echo "- Release APKè·¯å¾„ï¼š${{ steps.build_release.outputs.release_apk_path || 'æœªæ„å»º/å¤±è´¥' }}"
          echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
